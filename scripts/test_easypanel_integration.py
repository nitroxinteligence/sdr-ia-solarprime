#!/usr/bin/env python3
"""
Test EasyPanel Integration
=========================
Script completo para testar a integra√ß√£o do SDR IA com Evolution API no EasyPanel.
"""

import asyncio
import os
import sys
import httpx
from dotenv import load_dotenv
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
from datetime import datetime
import json

# Adicionar diret√≥rio pai ao path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# Carregar vari√°veis de ambiente
load_dotenv()

console = Console()


class EasyPanelTester:
    """Classe para testar integra√ß√£o no EasyPanel"""
    
    def __init__(self):
        self.evolution_url = os.getenv("EVOLUTION_API_URL", "")
        self.api_key = os.getenv("EVOLUTION_API_KEY", "")
        self.instance_name = os.getenv("EVOLUTION_INSTANCE_NAME", "")
        self.webhook_base_url = os.getenv("WEBHOOK_BASE_URL", "")
        
        # Remover /manager se existir
        if self.evolution_url.endswith('/manager'):
            self.evolution_url = self.evolution_url[:-8]
        
        self.headers = {
            "apikey": self.api_key,
            "Content-Type": "application/json"
        }
        
        self.test_results = []
    
    def add_result(self, test_name: str, success: bool, details: str = ""):
        """Adiciona resultado de teste"""
        self.test_results.append({
            "test": test_name,
            "success": success,
            "details": details
        })
    
    async def test_local_api(self):
        """Testa se a API local est√° rodando"""
        console.print("\n[bold]1Ô∏è‚É£ Testando API Local[/bold]")
        
        try:
            async with httpx.AsyncClient(timeout=5.0) as client:
                response = await client.get("http://localhost:8000/")
                
                if response.status_code == 200:
                    data = response.json()
                    console.print(f"[green]‚úÖ API rodando: {data.get('status')}[/green]")
                    console.print(f"[dim]Vers√£o: {data.get('version')} | Agent: {data.get('agent')}[/dim]")
                    self.add_result("API Local", True, "Rodando normalmente")
                else:
                    console.print(f"[red]‚ùå API com problema: HTTP {response.status_code}[/red]")
                    self.add_result("API Local", False, f"HTTP {response.status_code}")
        except Exception as e:
            console.print(f"[red]‚ùå API n√£o est√° rodando: {e}[/red]")
            self.add_result("API Local", False, "N√£o est√° rodando")
            console.print("[yellow]üí° Execute: uvicorn api.main:app --reload --host 0.0.0.0 --port 8000[/yellow]")
    
    async def test_evolution_connection(self):
        """Testa conex√£o com Evolution API"""
        console.print("\n[bold]2Ô∏è‚É£ Testando Conex√£o com Evolution API[/bold]")
        console.print(f"[dim]URL: {self.evolution_url}[/dim]")
        
        try:
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.get(
                    f"{self.evolution_url}/instance/fetchInstances",
                    headers=self.headers
                )
                
                if response.status_code == 200:
                    console.print("[green]‚úÖ Conectado √† Evolution API[/green]")
                    self.add_result("Evolution API", True, "Conectado")
                    return True
                else:
                    console.print(f"[red]‚ùå Erro na Evolution API: HTTP {response.status_code}[/red]")
                    self.add_result("Evolution API", False, f"HTTP {response.status_code}")
                    return False
        except Exception as e:
            console.print(f"[red]‚ùå N√£o foi poss√≠vel conectar: {e}[/red]")
            self.add_result("Evolution API", False, str(e))
            return False
    
    async def test_instance_exists(self):
        """Verifica se a inst√¢ncia existe"""
        console.print("\n[bold]3Ô∏è‚É£ Verificando Inst√¢ncia[/bold]")
        console.print(f"[dim]Nome: {self.instance_name}[/dim]")
        
        try:
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.get(
                    f"{self.evolution_url}/instance/fetchInstances",
                    headers=self.headers
                )
                
                if response.status_code == 200:
                    instances = response.json()
                    
                    # Procurar inst√¢ncia
                    instance_found = False
                    instance_status = None
                    
                    for inst in instances:
                        inst_data = inst.get("instance", {})
                        if inst_data.get("instanceName") == self.instance_name:
                            instance_found = True
                            instance_status = inst_data.get("status")
                            break
                    
                    if instance_found:
                        if instance_status == "open":
                            console.print(f"[green]‚úÖ Inst√¢ncia '{self.instance_name}' conectada ao WhatsApp[/green]")
                            self.add_result("Inst√¢ncia WhatsApp", True, "Conectada")
                        else:
                            console.print(f"[yellow]‚ö†Ô∏è  Inst√¢ncia encontrada mas n√£o conectada: {instance_status}[/yellow]")
                            self.add_result("Inst√¢ncia WhatsApp", False, f"Status: {instance_status}")
                    else:
                        console.print(f"[red]‚ùå Inst√¢ncia '{self.instance_name}' n√£o encontrada[/red]")
                        console.print("\n[yellow]Inst√¢ncias dispon√≠veis:[/yellow]")
                        for inst in instances:
                            name = inst.get("instance", {}).get("instanceName", "N/A")
                            console.print(f"  - {name}")
                        self.add_result("Inst√¢ncia WhatsApp", False, "N√£o encontrada")
        except Exception as e:
            console.print(f"[red]‚ùå Erro ao verificar inst√¢ncia: {e}[/red]")
            self.add_result("Inst√¢ncia WhatsApp", False, str(e))
    
    async def test_webhook_config(self):
        """Testa configura√ß√£o do webhook"""
        console.print("\n[bold]4Ô∏è‚É£ Verificando Webhook[/bold]")
        
        try:
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.get(
                    f"{self.evolution_url}/webhook/find/{self.instance_name}",
                    headers=self.headers
                )
                
                if response.status_code == 200:
                    config = response.json()
                    webhook_url = config.get("url", "")
                    enabled = config.get("enabled", False)
                    
                    console.print(f"[dim]URL Configurada: {webhook_url}[/dim]")
                    console.print(f"[dim]Status: {'Ativo' if enabled else 'Inativo'}[/dim]")
                    
                    # Verificar se est√° usando comunica√ß√£o interna
                    if webhook_url and "sdr-ia" in webhook_url and ":8000" in webhook_url:
                        console.print("[green]‚úÖ Webhook configurado para comunica√ß√£o interna[/green]")
                        self.add_result("Webhook Config", True, "Comunica√ß√£o interna")
                    elif webhook_url:
                        console.print("[yellow]‚ö†Ô∏è  Webhook configurado mas n√£o para comunica√ß√£o interna[/yellow]")
                        self.add_result("Webhook Config", False, "N√£o usa comunica√ß√£o interna")
                    else:
                        console.print("[red]‚ùå Webhook n√£o configurado[/red]")
                        self.add_result("Webhook Config", False, "N√£o configurado")
                else:
                    console.print("[red]‚ùå Webhook n√£o encontrado[/red]")
                    self.add_result("Webhook Config", False, "N√£o encontrado")
        except Exception as e:
            console.print(f"[red]‚ùå Erro ao verificar webhook: {e}[/red]")
            self.add_result("Webhook Config", False, str(e))
    
    async def test_webhook_endpoint(self):
        """Testa endpoint do webhook localmente"""
        console.print("\n[bold]5Ô∏è‚É£ Testando Endpoint do Webhook[/bold]")
        
        test_payload = {
            "event": "TEST_EVENT",
            "instance": self.instance_name,
            "data": {
                "test": True,
                "timestamp": datetime.now().isoformat()
            }
        }
        
        try:
            async with httpx.AsyncClient(timeout=5.0) as client:
                response = await client.post(
                    "http://localhost:8000/webhook/whatsapp",
                    json=test_payload
                )
                
                if response.status_code == 200:
                    console.print("[green]‚úÖ Webhook endpoint respondendo[/green]")
                    self.add_result("Webhook Endpoint", True, "Respondendo")
                else:
                    console.print(f"[red]‚ùå Webhook retornou: HTTP {response.status_code}[/red]")
                    self.add_result("Webhook Endpoint", False, f"HTTP {response.status_code}")
        except Exception as e:
            console.print(f"[red]‚ùå Erro ao testar webhook: {e}[/red]")
            self.add_result("Webhook Endpoint", False, str(e))
    
    async def simulate_whatsapp_message(self):
        """Simula uma mensagem do WhatsApp"""
        console.print("\n[bold]6Ô∏è‚É£ Simulando Mensagem do WhatsApp[/bold]")
        
        message_payload = {
            "event": "MESSAGES_UPSERT",
            "instance": self.instance_name,
            "data": {
                "key": {
                    "id": f"TEST_{int(datetime.now().timestamp())}",
                    "remoteJid": "5511999999999@s.whatsapp.net",
                    "fromMe": False
                },
                "message": {
                    "conversation": "Ol√°! Quero saber sobre energia solar"
                },
                "messageTimestamp": int(datetime.now().timestamp()),
                "pushName": "Cliente Teste EasyPanel"
            }
        }
        
        try:
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.post(
                    "http://localhost:8000/webhook/whatsapp",
                    json=message_payload
                )
                
                if response.status_code == 200:
                    console.print("[green]‚úÖ Mensagem simulada processada[/green]")
                    self.add_result("Simula√ß√£o WhatsApp", True, "Processada")
                    console.print("[dim]Verifique os logs para ver o processamento[/dim]")
                else:
                    console.print(f"[red]‚ùå Erro ao processar: HTTP {response.status_code}[/red]")
                    self.add_result("Simula√ß√£o WhatsApp", False, f"HTTP {response.status_code}")
        except Exception as e:
            console.print(f"[red]‚ùå Erro na simula√ß√£o: {e}[/red]")
            self.add_result("Simula√ß√£o WhatsApp", False, str(e))
    
    def show_results(self):
        """Mostra resumo dos testes"""
        console.print("\n")
        
        # Criar tabela de resultados
        table = Table(title="üìä Resumo dos Testes")
        table.add_column("Teste", style="cyan")
        table.add_column("Resultado", style="green")
        table.add_column("Detalhes", style="dim")
        
        total_tests = len(self.test_results)
        passed_tests = sum(1 for r in self.test_results if r["success"])
        
        for result in self.test_results:
            status = "[green]‚úÖ Passou[/green]" if result["success"] else "[red]‚ùå Falhou[/red]"
            table.add_row(result["test"], status, result["details"])
        
        console.print(table)
        
        # Mostrar estat√≠sticas
        success_rate = (passed_tests / total_tests * 100) if total_tests > 0 else 0
        
        console.print(f"\n[bold]üìà Taxa de Sucesso: {success_rate:.0f}% ({passed_tests}/{total_tests})[/bold]")
        
        # Recomenda√ß√µes baseadas nos resultados
        if success_rate < 100:
            console.print("\n[yellow]üí° Recomenda√ß√µes:[/yellow]")
            
            for result in self.test_results:
                if not result["success"]:
                    if result["test"] == "API Local":
                        console.print("‚Ä¢ Inicie a API: uvicorn api.main:app --reload --host 0.0.0.0 --port 8000")
                    elif result["test"] == "Evolution API":
                        console.print("‚Ä¢ Verifique se a Evolution API est√° rodando no EasyPanel")
                        console.print("‚Ä¢ Confirme a URL e API Key no .env")
                    elif result["test"] == "Inst√¢ncia WhatsApp":
                        console.print("‚Ä¢ Execute: python scripts/list_evolution_instances.py")
                        console.print("‚Ä¢ Verifique o nome correto da inst√¢ncia")
                    elif result["test"] == "Webhook Config":
                        console.print("‚Ä¢ Execute: python scripts/configure_webhook_easypanel.py")
                        console.print("‚Ä¢ Configure o webhook para comunica√ß√£o interna")
        else:
            console.print("\n[green]üéâ Todos os testes passaram! Sistema pronto para deploy![/green]")
            
            # Instru√ß√µes finais
            console.print("\n")
            console.print(Panel(
                "[bold green]üöÄ Pr√≥ximos Passos para Deploy no EasyPanel:[/bold green]\n\n"
                "1. Fa√ßa commit das altera√ß√µes\n"
                "2. No EasyPanel, crie o servi√ßo 'sdr-ia'\n"
                "3. Configure as vari√°veis de ambiente do .env.easypanel\n"
                "4. Fa√ßa o deploy usando o Dockerfile\n"
                "5. Aguarde o build e inicializa√ß√£o\n"
                "6. Teste enviando mensagem no WhatsApp!",
                border_style="green"
            ))


async def main():
    """Fun√ß√£o principal"""
    
    console.print(Panel.fit(
        "[bold]üß™ SDR IA SolarPrime - Teste de Integra√ß√£o EasyPanel[/bold]\n"
        f"[dim]{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}[/dim]",
        border_style="bold blue"
    ))
    
    # Criar testador
    tester = EasyPanelTester()
    
    # Executar testes
    await tester.test_local_api()
    
    # S√≥ continuar se API local estiver rodando
    if any(r["test"] == "API Local" and r["success"] for r in tester.test_results):
        if await tester.test_evolution_connection():
            await tester.test_instance_exists()
            await tester.test_webhook_config()
        
        await tester.test_webhook_endpoint()
        await tester.simulate_whatsapp_message()
    
    # Mostrar resultados
    tester.show_results()


if __name__ == "__main__":
    asyncio.run(main())